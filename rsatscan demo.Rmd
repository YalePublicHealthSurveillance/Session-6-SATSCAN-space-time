---
title: "rsatscan intro"
author: "Dan Weinberger"
date: "February 25, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rsatscan)
library(rgdal)
library(lubridate)
library(readxl)
library(zipcodeR)
```


## Download the ZIP-code level file from NYC
Save as an .xlsx file to avoid formatting issues with their text files.
```{r}

d1 <- read_excel('./Data/nyc_spring_2020.xlsx')

d1$Date <- as.Date(d1$Date)
```

Restrict to 65+ year olds, between mid Feb and mid-March
```{r}
d1 <- 
  d1[d1$Dim1Name=='Zip' & d1$Dim2Value=="Ages 65+ years" &d1$Date>='2020-02-15' & d1$Date<='2020-03-20',]

cases <- d1[,c('Date','Zip','Count')]
```

Geocode the ZIPs using the geocode_zip() function and merge the coordinates back in with the ZIPs

```{r}
coord1 <- geocode_zip(unique(cases$Zip))

cases2 <- merge(cases, coord1, by.x='Zip', by.y='zipcode')
```

Export the case file
```{r}
write.csv(cases2, './Data/nyc_resp_spring2020.csv')
```


## Data for rsatscan

case file just needs to have ZIP, date (Y/m/d)
```{r}
nyc_cas <- cases2[,c("Zip",'Count','Date')]
nyc_cas$Date <- paste(year(cases2$Date), month(nyc_cas$Date),day(nyc_cas$Date), sep='/')
```

geo file needs  to have one row per zip, with lat and lng
```{r}
nyc_geo <- unique(cases2[c('Zip', 'lat','lng')])
```


Read in shape file for mapping
"dsn"" gives the folder where the .shp file is saved; layer gives the name of the .shp file. Note the folder must contain the .shp files as well as the .prj, .shx, .dbf files.
```{r}
shape.NYC <- readOGR(dsn = "./Data/NYC shape files", layer = "geo_export_ef7f38de-fdc9-46c6-bf6b-36dcb40dfda8")
```

## Specify the parameters for SATSCAN and generate the input files needed
Save in a temporary directory
```{r}
invisible(ss.options(reset=TRUE)) #Reset parameters
```

Parameters for SATSCAN
```{r}
ss.options(list(CaseFile="NYC_resp.cas", PrecisionCaseTimes=3))

ss.options(c("StartDate=2020/02/15","EndDate=2020/03/20"))

ss.options(list(CoordinatesFile="NYC_resp.geo", AnalysisType=4, ModelType=2, TimeAggregationUnits=3))

ss.options(list(UseDistanceFromCenterOption="y", MaxSpatialSizeInDistanceFromCenter=3, NonCompactnessPenalty=0))

ss.options(list(MaxTemporalSizeInterpretation=1, MaxTemporalSize=7))

ss.options(list(ProspectiveStartDate="2020/03/10", ReportGiniClusters="n", LogRunToHistoryFile="n"))
```

Where to savethe output?
```{r}
td = './Manual results/'
write.ss.prm(td,  "NYC_resp")
write.cas(nyc_cas, td, "NYC_resp")
write.geo(nyc_geo, td, "NYC_resp")
```


#Run SATSCAN
Save results in an object called "NYCfever"
Need to point to directory on your computer where SATSCAN program is saved
```{r}
NYCfever = satscan(td, "NYCfever", sslocation = "C:/Program Files/SaTScan")
```

## Summary of results

```{r}
summary(NYCfever)
```

#Cluster info
```{r}
#See the main results and info about each cluster
NYCfever$main
```

## Map the results

```{r}
sp::plot(shape.NYC)  #Map NYC borough boundaries
sp::plot(NYCfever$shapeclust, add=T, col='red', pch=16) #Overlay the SATSCAN cluster results
```

## View the SATSCAN results compared to Monte Carlo resampling

```{r}
#View the clusters vs the Monte Carlo simulations to see how unlikely the result is
hist(unlist(NYCfever$llr), main="Monte Carlo")
abline(v=NYCfever$col[,c("TEST_STAT")], col = "red")
```
